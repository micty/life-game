!function(e,n,t,r,i,a,l,c,o,u,s,d,f,m,p,h,v,b,g,w,y,$,x,q,S){f("Table/Meta/Column",function(e,n,t){var r=e("KISP"),i=(r.require("Array"),r.require("String"));r.require("Object");return{create:function(e){var n=i.random(),t={name:e.name,caption:e.caption,index:e.index,field:e.field,table:e.table,id:n,cells:[],data:{},deps:[],infers:[],type:"Table.Column",change:null,sum:function(n){var r=0;return t.cells.map(function(t,i){var a=n?n.call(e.table,t,i):t.value;null!==a&&(r+=a=a||0)}),r}};return t}}}),f("Table/Meta",function(e,n,t){e("$");var r=e("KISP").require("String"),i=n.require("Column");return{create:function(e,n){if(e.x){var t=" ".repeat(e.x).split("").map(function(n,t){return{[e.columnName]:`Column${t}`}});e.fields=t}e.y&&(e.count=e.y);var a=e.count||e.details.length,l={},c={},o=e.fields.map(function(t,r){var a=t[e.columnName],o=t[e.captionName],u=i.create({name:a,caption:o,index:r,field:t,table:n.this});return l[a]=u,c[u.id]=u,u}),u={id:r.random(),fields:e.fields,columnName:e.columnName,captionName:e.captionName,details:e.details,ctn:e.container,width:e.width,class:e.class,order:e.order,attributes:e.attributes,count:a,columns:o,id$column:c,name$column:l,rows:[],id$row:{},id$cell:{},emitter:null,tpl:null,element:null,$:null,$tbody:null,$ctn:null,this:null};return $.assign(u,n),u}}}),f("Table/Order",function(e,n,t){var r=e("KISP"),i=(r.require("Array"),r.require("String"),r.require("Object"),{sample:"{order}",add:!0,index:0});return{normalize:function(e){var n=e.order;if(!n)return e;!0===n&&(n={}),n=$.assign({},i,n);var t=e.fields.slice(0),r={[e.columnName]:"order",caption:"序号"},a=n.index;return n.add?t.splice(a,0,r):t[a]=r,e=$.assign({},e,{order:n,fields:t})}}}),f("Table/Reaction",function(e,n,t){function r(e,n,t,r){var i=e[n];i?(r&&(i.change=r),t&&(i.deps.splice(0),i.deps.push(...t),t.map(function(t){var r=e[t];if(r){var i=r.infers;(i=new Set(i)).add(n),r.infers.splice(0),r.infers.push(...i)}else c.warn("不存在名为 "+n+" 的列。")}))):c.warn("不存在名为 "+n+" 的列。")}e("$");var i=e("KISP"),a=(i.require("Emitter"),i.require("Array"),i.require("String"),i.require("Object"));e("Defaults");return{set:function(e,n,t){var i=this;if(a.isPlain(e))a.each(e,function(e,n){m.isArray(n)?r(i,e,n,null):"function"!=typeof n?r(i,e,n.deps,n.change):r(i,e,null,n)});else if(a.isPlain(n)){var l=n;r(i,e,l.deps,l.change)}else"function"==typeof n&&(t=n,n=null),r(i,e,n,t)}}}),f("Table/Row",function(e,n,t){var i=e("KISP"),a=(e("$"),i.require("Array"),i.require("String"));i.require("Object");return t={create:function(e,n){var t=e.rows,r=a.random(),i=t.length,l=$.assign({},n),o={},u=e.id$row[r]={id:r,index:i,type:"Table.Row",cells:null,table:this,element:null,data:l,name$cell:o,value:null,title:"",class:"",attributes:{index:i}};return u.valueOf=function(e){return o[e].value},u.cells=e.fields.map(function(n,t){var r=a.random(),i=e.columns[t],l=e.order.index==t,s=n[e.columnName],d=n[e.captionName],f=e.id$cell[r]={id:r,name:s,caption:d,type:"Table.Cell",row:u,field:n,index:t,isOrder:l,column:i,table:e.this,ctrl:null,element:null,value:null,data:{},deps:i.deps,infers:i.infers,title:"",html:"",class:n.class||"",attributes:{index:t,name:s}};return f.change=function(n,t){(t=t||[]).push(f),f.value=n,c.log(t),f.infers.map(function(n){var r=e.name$column[n],i=o[n],a=r.change;if(!t.includes(i)&&a){var l=a.apply(i,[f,t]);l!==S&&(i.value=l)}}),e.emitter.fire("change",f.name,[f]),e.emitter.fire("change",[f])},i.cells.push(f),o[s]=f,f}),t.push(u),u},add:function(e,n){var i=e.rows.length,a=t.create(e,n),l=e.tpl.fill("tr",a,i);return e.$tbody.append(l),a.element=r.getElementById(a.id),a.cells.map(function(e){e.element=r.getElementById(e.id)}),a},remove:function(e,n){var t=e.rows,r=t[n];t.splice(n,1),delete e.id$row[r.id],r.cells.map(function(n){var t=n.ctrl;t&&t.destroy(),delete e.id$cell[n.id],n.ctrl=null,n.element=null}),e.columns.map(function(e,t){e.cells.splice(n,1)});var i=r.element;return i&&i.parentNode.removeChild(i),r.element=null,t.slice(n).map(function(t,r){if(r=t.index=r+n,"index"in t.attributes&&(t.element.setAttribute("data-index",r),t.attributes.index=r),e.order){var i=e.tpl;t.cells.map(function(e){if(e.isOrder){var n=i.fill("tr","td",e,0,r);e.element.innerHTML=n}})}}),r},move:function(e,n,t){var r=e.rows,i=n+t;if(!(0==t||i<0||i>r.length-1)){var a=r[n],l=r[i],c=a.element.parentNode;r.splice(n,1),r.splice(i,0,a),t>0?c.insertBefore(l.element,a.element):c.insertBefore(a.element,l.element),r.map(function(n,t){n.index!=t&&(n.index=t,"index"in n.attributes&&(n.element.setAttribute("data-index",t),n.attributes.index=t),e.order&&n.cells.map(function(n){if(n.isOrder){var r=e.tpl.fill("tr","td",n,0,t);n.element.innerHTML=r}}))}),e.emitter.fire("move",[a,t])}}}}),f("Table/Static",function(e,n,t){e("$");var r=e("KISP"),i=(r.require("Emitter"),r.require("Array"),r.require("String"),r.require("Object"));e("Defaults");return t={eachCell:function(e,n){m.isArray(e)||(e=[e]);var t=[];e.map(function(e){switch(e.type){case"Table.Cell":t.push(e);break;case"Table.Column":case"Table.Row":t=t.concat(e.cells);break;default:throw new v("无法识别的 type 值: "+type)}}),t.map(n)},column:function(e,n,r){var i=[];if(m.isArray(e))e.map(function(e){if(t.isRow(e)){var r=e.name$cell[n];r&&i.push(r)}});else if(t.isRow(e)){var a=e.name$cell[n];a&&i.push(a)}else{var l=e.get("name$column")[n];l&&(i=l.cells||[])}i.map(function(e,n){r(e,n)})},isCell:function(e){return i.isPlain(e)&&"Table.Cell"==e.type},isRow:function(e){return i.isPlain(e)&&"Table.Row"==e.type},isColumn:function(e){return i.isPlain(e)&&"Table.Column"==e.type}}}),f("Table/Template",function(e,n){function t(e){return e?(e=$.entries(e).map(function(e){return"data-"+e[0]+'="'+e[1]+'"'})).join(" "):""}function r(e){var n=e.title;return n===S||""===n?"":'title="'+n+'"'}function i(e){var n=e.class;return m.isArray(n)&&(n=n.join(" ")),n?'class="'+n+'"':""}e("$");var a=d.require("Template"),l=(d.require("Array"),d.require("String"));return{create:function(e){var n=new a("#tpl-Table"),c=e.emitter;return n.process({"":function(){this.fix("attributes");var n=e.width||"";n&&(n="width: "+n+"px;");var r=this.fill("tr",e.rows),i=t(e.attributes),a=e.class||"";return{id:e.id,class:a+" Table",width:n,rows:r,attributes:i}},tr:{"":function(e,n){this.fix(["class","attributes","title"]),c.fire("process","row",[e,n]);var a=t(e.attributes),l=this.fill("td",e.cells,n),o=r(e),u=i(e);return{id:e.id,class:u,attributes:a,title:o,cells:l}},td:{"":function(n,a,o){this.fix(["class","attributes","title"]);var u="";if(n.isOrder)u=l.format(e.order.sample,{index:a,no:o,order:o+1});else{var s=c.fire("process","cell",n.name,[n,a]);(u=s.slice(-1)[0])===S&&(u=(s=c.fire("process","cell",[n,a])).slice(-1)[0]);var d=typeof u;"number"!=d&&"boolean"!=d||(u=q(u))}var f=!1===n.field.visible?"display: none;":"",m=t(n.attributes),p=r(n),h=i(n);return{id:n.id,cid:n.column.id,html:u||"",class:h,attributes:m,display:f,title:p}}}}}),n}}}),f("Table.defaults",{$:null,fields:[],width:0,widths:[],class:"",process:{},order:!1,details:[],columnName:"fieldName",captionName:"caption"}),f("Table",function(e,n,t){function i(e){e=s.clone(n,e),e=b.normalize(e);var t=new o(this),r=g.create(e,{emitter:t,this:this});r.tpl=p.create(r),w.set(this,r),$.assign(this,{id:r.id,meta:r});for(var i=0;i<r.count;i++)this.new(r.details[i]);var a=e.reaction;a&&this.reaction(a),this.on("process","cell",function(e){return(e.row.data||{})[e.name]})}var a=e("$"),l=e("KISP"),o=l.require("Emitter"),u=(l.require("Array"),l.require("String"),l.require("Object")),s=e("Defaults"),d=n.require("Reaction"),f=n.require("Static"),p=n.require("Template"),h=n.require("Row"),b=n.require("Order"),g=n.require("Meta"),w=new Map;return i.prototype={constructor:i,id:"",$:null,render:function(){var e=w.get(this),n=e.rows,t=e.tpl.fill({});if(e.$ctn=a(e.ctn),!e.$ctn.length)throw new v("不存在容器节点: "+e.ctn);return e.$ctn.html(t),this.length=e.rows.length,e.rows.map(function(n){e.this[n.index]=n,n.element=r.getElementById(n.id),n.$=a(n.element),n.length=n.cells.length,n.cells.map(function(e){e.element=r.getElementById(e.id),e.$=a(e.element),e.x=e.index,e.y=n.index,e.neighbors=[],n[e.index]=e})}),e.element=r.getElementById(e.id),e.$=this.$=a(e.element),e.$tbody=e.$.find(">tbody"),e.fields.forEach(function(n,t){var r=n.delegate;r&&(m.isArray(r)?r:[r]).forEach(function(t){var r='>tr>td[data-name="'+n[e.columnName]+'"] '+t;e.$tbody.on("click",r,function(n){for(var r=a(this).parents().toArray(),i=r.length,l=0;l<i;l++){var c=r[l].id,o=e.id$cell[c];if(o){e.emitter.fire("click","cell",o.name,t,[o,n,this]);break}}})})}),e.$tbody.on("click",">tr>td",function(n){var t=e.id$cell[this.id];e.emitter.fire("click","cell",t.name,[t,n]),e.emitter.fire("click","cell",[t,n])}),e.$tbody.on("click",">tr",function(n){var t=e.id$row[this.id];e.emitter.fire("click","row",[t,n])}),e.$tbody.on("click",function(n){e.emitter.fire("click",[n])}),e.emitter.fire("render",[n]),t},each:function(e){w.get(this).rows.forEach(function(n){n.cells.forEach(function(n){e&&e(n)})})},new:function(e){var n=w.get(this),t=h.create(n,e);return n.emitter.fire("new",[t,e]),t},add:function(e){var n=w.get(this);if(m.isArray(e)){var t=e.map(function(e){return h.add(n,e)});return n.emitter.fire("add",[t]),t}var r=h.add(n,e);return n.emitter.fire("add",[r]),r},remove:function(e){var n=w.get(this);"number"!=typeof e&&(e=n.rows.length-1);var t=h.remove(n,e);n.emitter.fire("remove",[t,e])},move:function(e,n){var t=w.get(this),r=typeof e,i="number"==r?t.rows[e]:"string"==r?t.id$row[e]:"object"==r?t.id$row[e.id]:null;if(!i)throw new v("传入的参数 item 不属性当前 table 的表格行。");h.move(t,i.index,n)},fill:function(e){this.clear();var n=w.get(this),t=e.map(function(e){return this.new(e)},this),i=n.tpl.fill("tr",t);n.$tbody.html(i),t.map(function(e){e.element=r.getElementById(e.id),e.cells.map(function(e){e.element=r.getElementById(e.id)})}),n.emitter.fire("fill",[e])},clear:function(){var e=w.get(this);e.rows.map(function(e){e.cells.map(function(e){var n=e.ctrl;n&&n.destroy&&n.destroy()})}),e.columns.map(function(e){e.cells.splice(0)}),e.id$row={},e.id$cell={},e.rows.splice(0),e.$tbody.html(""),e.emitter.fire("clear")},get:function(e){var n=w.get(this),t=n.rows;if(0==arguments.length)return t;if("number"==typeof e)return t[e];switch(e){case"id$row":case"id$cell":case"id$column":case"name$column":case"rows":case"columns":case"element":case"details":return n[e];case"length":return t.length}return"string"==typeof e?n.id$cell[e]||n.id$row[e]||n.id$column[e]:void 0},set:function(e,n){var t=w.get(this);switch(e){case"width":t[e]=n}},column:function(e,n){var t=w.get(this).name$column[e];if(t)return t.cells.map(function(e,t){n&&n(e,t)}),t;c.warn("不存在名为 "+e+" 的列。")},reaction:function(e,n,t){var r=w.get(this);d.set.call(r.name$column,...arguments)},destroy:function(){var e=w.get(this);if(e){var n=e.element;e.tpl.destroy(),e.emitter.destroy(),n.parentNode.removeChild(n),e.$tbody.off(),e.$.off(),u.each(e.id$cell,function(e,n){var t=n.ctrl;t&&t.destroy&&t.destroy()}),w.delete(this)}},on:function(){w.get(this).emitter.on(...arguments)},filter:function(e){w.get(this);var n=[];return this.each(function(t){!0===e(t)&&n.push(t)}),n},stat:function(e){return this.filter(e).length}},$.assign(i,f),i}),f("Defaults",function(e,n,t){var r=d.require("Object");return t={get:function(n){if("string"==typeof n)return i=e(t=n+".defaults");var t=n.name+".defaults",r=n.parent,i=r?r.require(t):e(t);return i},clone:function(e,n,i,a){var l=t.get(e),c=m.from(arguments).slice(1);return c=[{},l].concat(c),l=r.extendDeeply.apply(null,c)}}}),d.panel("/Game/Sidebar/Config",function(e,n,t){var i=e("KISP").data(n.id);return t.on("init",function(){t.$.on("change","input",function(){var e=n.exports.get();t.fire("change",[e])})}),t.on("render",function(){var e=r.body.clientWidth-300,a=r.body.clientHeight,l=i.size,c=2*l+1,o=w.floor(a/c),u=w.floor(e/c);t.fill({row:o,column:u,frequency:10,size:l});var s=n.exports.get();t.fire("change",[s])}),{get:function(){var e=+t.$.find('input[name="row"]').val(),n=+t.$.find('input[name="column"]').val(),r=+t.$.find('input[name="size"]').val(),i=+t.$.find('input[name="frequency"]').val();return{row:e,column:n,frequency:i,interval:1e3/i,total:e*n,size:r}},enable:function(e){t.$.toggleClass("disabled",!e)}}}),d.panel("/Game/Sidebar/Coordinate",function(e,n,t){e("KISP");t.on("init",function(){}),t.on("render",function(e){e=e||{x:"",y:""},t.fill(e)})}),d.panel("/Game/Sidebar/Operator",function(e,n,t){e("KISP");var r=!1;t.on("init",function(){t.template().fix("disabled"),t.$on("click",{'[data-cmd="run"]':function(){r=!r,t.render(),t.fire(r?"start":"stop")},'[data-cmd="clear"]':function(){t.fire("clear")}})}),t.on("render",function(){t.fill({text:r?"停止...":"开始",class:r?"running":"",disabled:r?"disabled":""})})}),d.panel("/Game/Sidebar/Stat",function(e,n,t){e("KISP");var r={frame:0,checked:0,unchecked:0,total:0};t.on("init",function(){}),t.on("render",function(e){$.assign(r,e),r.unchecked=r.total-r.checked,t.fill(r)})}),f("/Game/Table/Collection",function(e,n,t){function r(e){var n=e.table,t=e.index,r=e.row.index;return[n[r-1][t-1],n[r-1][t+0],n[r-1][t+1],n[r+0][t-1],n[r+0][t+1],n[r+1][t-1],n[r+1][t+0],n[r+1][t+1]]}function i(e,n){var t=n.table,i=n.index,a=n.row.index;if(!(0==i||i==n.row.length-1||0==a||a==t.length-1)){var l=0;r(n).forEach(function(e){e.data.checked&&l++}),3!=l?2!=l&&(l<2?n.data.checked&&e.push(n):l>3&&n.data.checked&&e.push(n)):n.data.checked||e.push(n)}}e("KISP");return{get:function(e){var n=[];return e.each(function(e){i(n,e)}),n}}}),d.panel("/Game/Sidebar",function(e,n,t){e("KISP");var r=n.require("Coordinate"),i=n.require("Operator"),a=n.require("Config"),l=n.require("Stat"),c={frames:0,interval:0,total:0};return t.on("init",function(){function e(){n=u(function(){c.frames++,t.fire("frame"),n&&e()},c.interval)}var n=null;i.on({start:function(){n||(e(),a.enable(!1))},stop:function(){clearTimeout(n),n=null,a.enable(!0)},clear:function(){c.frames=0,l.render({frame:0,checked:0}),t.fire("clear")}}),a.on({change:function(e){c.interval=e.interval,c.total=e.total,t.fire("apply",[e])}})}),t.on("render",function(e){i.render(),a.render(),r.render(),l.render({frame:0,checked:0,total:c.total})}),{update:function(e){l.render({checked:e.checked,frame:c.frames,total:c.total})},coordinate:function(e){r.render(e)}}}),d.panel("/Game/Table",function(e,n,t){e("KISP");var r=e("Table"),i=n.require("Collection"),a=null,l={row:0,column:0,size:0};return t.on("init",function(){}),t.on("render",function(e){var n=e.row,i=e.column,c=e.size;if(a){if(n==l.row&&i==l.column)return void(c!=l.size&&(a.$.removeClass(`size-${l.size}`),a.$.addClass(`size-${c}`),l.size=c));a.destroy()}$.assign(l,e),(a=new r({container:t.container,x:i,y:n,class:`size-${c}`})).on("click",{cell:function(e,n){var r=0,i=e.data,l=i.checked=!i.checked;e.$.toggleClass("on",l);r=a.stat(function(e){return!!e.data.checked});t.fire("check",[r])}}),a.render(),a.$.on("mouseover","td",function(e){var n=this.id,r=a.get(n);t.fire("mouseover",[r])})}),{clear:function(){a&&a.each(function(e){e.data.checked=!1,e.$.removeClass("on")})},update:function(){return i.get(a).forEach(function(e){var n=e.data,t=n.checked=!n.checked;e.$.toggleClass("on",t)}),{checked:a.stat(function(e){return!!e.data.checked})}}}}),d.view("/Game",function(e,n,t){e("KISP");var r=n.require("Sidebar"),i=n.require("Table");t.on("init",function(){r.on({apply:function(e){i.render(e)},frame:function(){var e=i.update();r.update(e)},clear:function(){i.clear()}}),i.on({check:function(e){r.update({checked:e})},mouseover:function(e){r.coordinate({x:e.x,y:e.y})}})}),t.on("render",function(){r.render()})}),d.launch(function(e,n,t){n.require("Game").render()})}(top,parent,window,document,location,localStorage,sessionStorage,window.console||{log:function(){},dir:function(){},clear:function(){},error:function(){},info:function(){},debug:function(){},warn:function(){}},history,setTimeout,setInterval,KISP,define,Array,Boolean,Date,Error,Function,JSON,Math,Number,Object,RegExp,String);