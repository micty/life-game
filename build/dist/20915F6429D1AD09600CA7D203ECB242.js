!function(e,t,n,r,i,a,l,c,o,u,s,d,f,m,p,h,v,b,g,w,y,$,q,x,k){f("Table/Meta/Column",function(e,t,n){var r=e("KISP"),i=(r.require("Array"),r.require("String"));r.require("Object");return{create:function(e){var t=i.random(),n={name:e.name,caption:e.caption,index:e.index,field:e.field,table:e.table,id:t,cells:[],data:{},deps:[],infers:[],type:"Table.Column",change:null,sum:function(t){var r=0;return n.cells.map(function(n,i){var a=t?t.call(e.table,n,i):n.value;null!==a&&(r+=a=a||0)}),r}};return n}}}),f("Table/Meta",function(e,t,n){e("$");var r=e("KISP").require("String"),i=t.require("Column");return{create:function(e,t){if(e.x){var n=" ".repeat(e.x).split("").map(function(t,n){return{[e.columnName]:`Column${n}`}});e.fields=n}e.y&&(e.count=e.y);var a=e.count||e.details.length,l={},c={},o=e.fields.map(function(n,r){var a=n[e.columnName],o=n[e.captionName],u=i.create({name:a,caption:o,index:r,field:n,table:t.this});return l[a]=u,c[u.id]=u,u}),u={id:r.random(),fields:e.fields,columnName:e.columnName,captionName:e.captionName,details:e.details,ctn:e.container,width:e.width,class:e.class,order:e.order,attributes:e.attributes,count:a,columns:o,id$column:c,name$column:l,rows:[],id$row:{},id$cell:{},emitter:null,tpl:null,element:null,$:null,$tbody:null,$ctn:null,this:null};return $.assign(u,t),u}}}),f("Table/Order",function(e,t,n){var r=e("KISP"),i=(r.require("Array"),r.require("String"),r.require("Object"),{sample:"{order}",add:!0,index:0});return{normalize:function(e){var t=e.order;if(!t)return e;!0===t&&(t={}),t=$.assign({},i,t);var n=e.fields.slice(0),r={[e.columnName]:"order",caption:"序号"},a=t.index;return t.add?n.splice(a,0,r):n[a]=r,e=$.assign({},e,{order:t,fields:n})}}}),f("Table/Reaction",function(e,t,n){function r(e,t,n,r){var i=e[t];i?(r&&(i.change=r),n&&(i.deps.splice(0),i.deps.push(...n),n.map(function(n){var r=e[n];if(r){var i=r.infers;(i=new Set(i)).add(t),r.infers.splice(0),r.infers.push(...i)}else c.warn("不存在名为 "+t+" 的列。")}))):c.warn("不存在名为 "+t+" 的列。")}e("$");var i=e("KISP"),a=(i.require("Emitter"),i.require("Array"),i.require("String"),i.require("Object"));e("Defaults");return{set:function(e,t,n){var i=this;if(a.isPlain(e))a.each(e,function(e,t){m.isArray(t)?r(i,e,t,null):"function"!=typeof t?r(i,e,t.deps,t.change):r(i,e,null,t)});else if(a.isPlain(t)){var l=t;r(i,e,l.deps,l.change)}else"function"==typeof t&&(n=t,t=null),r(i,e,t,n)}}}),f("Table/Row",function(e,t,n){var i=e("KISP"),a=(e("$"),i.require("Array"),i.require("String"));i.require("Object");return n={create:function(e,t){var n=e.rows,r=a.random(),i=n.length,l=$.assign({},t),o={},u=e.id$row[r]={id:r,index:i,type:"Table.Row",cells:null,table:this,element:null,data:l,name$cell:o,value:null,title:"",class:"",attributes:{index:i}};return u.valueOf=function(e){return o[e].value},u.cells=e.fields.map(function(t,n){var r=a.random(),i=e.columns[n],l=e.order.index==n,s=t[e.columnName],d=t[e.captionName],f=e.id$cell[r]={id:r,name:s,caption:d,type:"Table.Cell",row:u,field:t,index:n,isOrder:l,column:i,table:e.this,ctrl:null,element:null,value:null,data:{},deps:i.deps,infers:i.infers,title:"",html:"",class:t.class||"",attributes:{index:n,name:s}};return f.change=function(t,n){(n=n||[]).push(f),f.value=t,c.log(n),f.infers.map(function(t){var r=e.name$column[t],i=o[t],a=r.change;if(!n.includes(i)&&a){var l=a.apply(i,[f,n]);l!==k&&(i.value=l)}}),e.emitter.fire("change",f.name,[f]),e.emitter.fire("change",[f])},i.cells.push(f),o[s]=f,f}),n.push(u),u},add:function(e,t){var i=e.rows.length,a=n.create(e,t),l=e.tpl.fill("tr",a,i);return e.$tbody.append(l),a.element=r.getElementById(a.id),a.cells.map(function(e){e.element=r.getElementById(e.id)}),a},remove:function(e,t){var n=e.rows,r=n[t];n.splice(t,1),delete e.id$row[r.id],r.cells.map(function(t){var n=t.ctrl;n&&n.destroy(),delete e.id$cell[t.id],t.ctrl=null,t.element=null}),e.columns.map(function(e,n){e.cells.splice(t,1)});var i=r.element;return i&&i.parentNode.removeChild(i),r.element=null,n.slice(t).map(function(n,r){if(r=n.index=r+t,"index"in n.attributes&&(n.element.setAttribute("data-index",r),n.attributes.index=r),e.order){var i=e.tpl;n.cells.map(function(e){if(e.isOrder){var t=i.fill("tr","td",e,0,r);e.element.innerHTML=t}})}}),r},move:function(e,t,n){var r=e.rows,i=t+n;if(!(0==n||i<0||i>r.length-1)){var a=r[t],l=r[i],c=a.element.parentNode;r.splice(t,1),r.splice(i,0,a),n>0?c.insertBefore(l.element,a.element):c.insertBefore(a.element,l.element),r.map(function(t,n){t.index!=n&&(t.index=n,"index"in t.attributes&&(t.element.setAttribute("data-index",n),t.attributes.index=n),e.order&&t.cells.map(function(t){if(t.isOrder){var r=e.tpl.fill("tr","td",t,0,n);t.element.innerHTML=r}}))}),e.emitter.fire("move",[a,n])}}}}),f("Table/Static",function(e,t,n){e("$");var r=e("KISP"),i=(r.require("Emitter"),r.require("Array"),r.require("String"),r.require("Object"));e("Defaults");return n={eachCell:function(e,t){m.isArray(e)||(e=[e]);var n=[];e.map(function(e){switch(e.type){case"Table.Cell":n.push(e);break;case"Table.Column":case"Table.Row":n=n.concat(e.cells);break;default:throw new v("无法识别的 type 值: "+type)}}),n.map(t)},column:function(e,t,r){var i=[];if(m.isArray(e))e.map(function(e){if(n.isRow(e)){var r=e.name$cell[t];r&&i.push(r)}});else if(n.isRow(e)){var a=e.name$cell[t];a&&i.push(a)}else{var l=e.get("name$column")[t];l&&(i=l.cells||[])}i.map(function(e,t){r(e,t)})},isCell:function(e){return i.isPlain(e)&&"Table.Cell"==e.type},isRow:function(e){return i.isPlain(e)&&"Table.Row"==e.type},isColumn:function(e){return i.isPlain(e)&&"Table.Column"==e.type}}}),f("Table/Template",function(e,t){function n(e){return e?(e=$.entries(e).map(function(e){return"data-"+e[0]+'="'+e[1]+'"'})).join(" "):""}function r(e){var t=e.title;return t===k||""===t?"":'title="'+t+'"'}function i(e){var t=e.class;return m.isArray(t)&&(t=t.join(" ")),t?'class="'+t+'"':""}e("$");var a=d.require("Template"),l=(d.require("Array"),d.require("String"));return{create:function(e){var t=new a("#tpl-Table"),c=e.emitter;return t.process({"":function(){this.fix("attributes");var t=e.width||"";t&&(t="width: "+t+"px;");var r=this.fill("tr",e.rows),i=n(e.attributes),a=e.class||"";return{id:e.id,class:a+" Table",width:t,rows:r,attributes:i}},tr:{"":function(e,t){this.fix(["class","attributes","title"]),c.fire("process","row",[e,t]);var a=n(e.attributes),l=this.fill("td",e.cells,t),o=r(e),u=i(e);return{id:e.id,class:u,attributes:a,title:o,cells:l}},td:{"":function(t,a,o){this.fix(["class","attributes","title"]);var u="";if(t.isOrder)u=l.format(e.order.sample,{index:a,no:o,order:o+1});else{var s=c.fire("process","cell",t.name,[t,a]);(u=s.slice(-1)[0])===k&&(u=(s=c.fire("process","cell",[t,a])).slice(-1)[0]);var d=typeof u;"number"!=d&&"boolean"!=d||(u=x(u))}var f=!1===t.field.visible?"display: none;":"",m=n(t.attributes),p=r(t),h=i(t);return{id:t.id,cid:t.column.id,html:u||"",class:h,attributes:m,display:f,title:p}}}}}),t}}}),f("Table.defaults",{$:null,fields:[],width:0,widths:[],class:"",process:{},order:!1,details:[],columnName:"fieldName",captionName:"caption"}),f("Table",function(e,t,n){function i(e){e=s.clone(t,e),e=b.normalize(e);var n=new o(this),r=g.create(e,{emitter:n,this:this});r.tpl=p.create(r),w.set(this,r),$.assign(this,{id:r.id,meta:r});for(var i=0;i<r.count;i++)this.new(r.details[i]);var a=e.reaction;a&&this.reaction(a),this.on("process","cell",function(e){return(e.row.data||{})[e.name]})}var a=e("$"),l=e("KISP"),o=l.require("Emitter"),u=(l.require("Array"),l.require("String"),l.require("Object")),s=e("Defaults"),d=t.require("Reaction"),f=t.require("Static"),p=t.require("Template"),h=t.require("Row"),b=t.require("Order"),g=t.require("Meta"),w=new Map;return i.prototype={constructor:i,id:"",$:null,render:function(){var e=w.get(this),t=e.rows,n=e.tpl.fill({});if(e.$ctn=a(e.ctn),!e.$ctn.length)throw new v("不存在容器节点: "+e.ctn);return e.$ctn.html(n),this.length=e.rows.length,e.rows.map(function(t){e.this[t.index]=t,t.element=r.getElementById(t.id),t.$=a(t.element),t.length=t.cells.length,t.cells.map(function(e){e.element=r.getElementById(e.id),e.$=a(e.element),e.x=e.index,e.y=t.index,e.neighbors=[],t[e.index]=e})}),e.element=r.getElementById(e.id),e.$=this.$=a(e.element),e.$tbody=e.$.find(">tbody"),e.fields.forEach(function(t,n){var r=t.delegate;r&&(m.isArray(r)?r:[r]).forEach(function(n){var r='>tr>td[data-name="'+t[e.columnName]+'"] '+n;e.$tbody.on("click",r,function(t){for(var r=a(this).parents().toArray(),i=r.length,l=0;l<i;l++){var c=r[l].id,o=e.id$cell[c];if(o){e.emitter.fire("click","cell",o.name,n,[o,t,this]);break}}})})}),e.$tbody.on("click",">tr>td",function(t){var n=e.id$cell[this.id];e.emitter.fire("click","cell",n.name,[n,t]),e.emitter.fire("click","cell",[n,t])}),e.$tbody.on("click",">tr",function(t){var n=e.id$row[this.id];e.emitter.fire("click","row",[n,t])}),e.$tbody.on("click",function(t){e.emitter.fire("click",[t])}),e.emitter.fire("render",[t]),n},each:function(e){w.get(this).rows.forEach(function(t){t.cells.forEach(function(t){e&&e(t)})})},new:function(e){var t=w.get(this),n=h.create(t,e);return t.emitter.fire("new",[n,e]),n},add:function(e){var t=w.get(this);if(m.isArray(e)){var n=e.map(function(e){return h.add(t,e)});return t.emitter.fire("add",[n]),n}var r=h.add(t,e);return t.emitter.fire("add",[r]),r},remove:function(e){var t=w.get(this);"number"!=typeof e&&(e=t.rows.length-1);var n=h.remove(t,e);t.emitter.fire("remove",[n,e])},move:function(e,t){var n=w.get(this),r=typeof e,i="number"==r?n.rows[e]:"string"==r?n.id$row[e]:"object"==r?n.id$row[e.id]:null;if(!i)throw new v("传入的参数 item 不属性当前 table 的表格行。");h.move(n,i.index,t)},fill:function(e){this.clear();var t=w.get(this),n=e.map(function(e){return this.new(e)},this),i=t.tpl.fill("tr",n);t.$tbody.html(i),n.map(function(e){e.element=r.getElementById(e.id),e.cells.map(function(e){e.element=r.getElementById(e.id)})}),t.emitter.fire("fill",[e])},clear:function(){var e=w.get(this);e.rows.map(function(e){e.cells.map(function(e){var t=e.ctrl;t&&t.destroy&&t.destroy()})}),e.columns.map(function(e){e.cells.splice(0)}),e.id$row={},e.id$cell={},e.rows.splice(0),e.$tbody.html(""),e.emitter.fire("clear")},get:function(e){var t=w.get(this),n=t.rows;if(0==arguments.length)return n;if("number"==typeof e)return n[e];switch(e){case"id$row":case"id$cell":case"id$column":case"name$column":case"rows":case"columns":case"element":case"details":return t[e];case"length":return n.length}return"string"==typeof e?t.id$cell[e]||t.id$row[e]||t.id$column[e]:void 0},set:function(e,t){var n=w.get(this);switch(e){case"width":n[e]=t}},column:function(e,t){var n=w.get(this).name$column[e];if(n)return n.cells.map(function(e,n){t&&t(e,n)}),n;c.warn("不存在名为 "+e+" 的列。")},reaction:function(e,t,n){var r=w.get(this);d.set.call(r.name$column,...arguments)},destroy:function(){var e=w.get(this);if(e){var t=e.element;e.tpl.destroy(),e.emitter.destroy(),t.parentNode.removeChild(t),e.$tbody.off(),e.$.off(),u.each(e.id$cell,function(e,t){var n=t.ctrl;n&&n.destroy&&n.destroy()}),w.delete(this)}},on:function(){w.get(this).emitter.on(...arguments)},filter:function(e){w.get(this);var t=[];return this.each(function(n){!0===e(n)&&t.push(n)}),t},stat:function(e){return this.filter(e).length}},$.assign(i,f),i}),f("Defaults",function(e,t,n){var r=d.require("Object");return n={get:function(t){if("string"==typeof t)return i=e(n=t+".defaults");var n=t.name+".defaults",r=t.parent,i=r?r.require(n):e(n);return i},clone:function(e,t,i,a){var l=n.get(e),c=m.from(arguments).slice(1);return c=[{},l].concat(c),l=r.extendDeeply.apply(null,c)}}}),d.panel("/Game/Sidebar/Config",function(e,t,n){var i=e("KISP").data(t.id);return n.on("init",function(){n.$.on("change","input",function(){var e=t.exports.get();n.fire("change",[e])})}),n.on("render",function(){var e=r.body.clientWidth-300,a=r.body.clientHeight,l=i.size,c=2*l+1,o=w.floor(a/c),u=w.floor(e/c);n.fill({row:o,column:u,frequency:10,size:l});var s=t.exports.get();n.fire("change",[s])}),{get:function(){var e=+n.$.find('input[name="row"]').val(),t=+n.$.find('input[name="column"]').val(),r=+n.$.find('input[name="size"]').val(),i=+n.$.find('input[name="frequency"]').val();return{row:e,column:t,frequency:i,interval:1e3/i,total:e*t,size:r}},enable:function(e){n.$.toggleClass("disabled",!e)}}}),d.panel("/Game/Sidebar/Operator",function(e,t,n){e("KISP");var r=!1;n.on("init",function(){n.template().fix("disabled"),n.$on("click",{'[data-cmd="run"]':function(){r=!r,n.render(),n.fire(r?"start":"stop")},'[data-cmd="clear"]':function(){n.fire("clear")}})}),n.on("render",function(){n.fill({text:r?"停止...":"开始",class:r?"running":"",disabled:r?"disabled":""})})}),d.panel("/Game/Sidebar/Stat",function(e,t,n){e("KISP");var r={frame:0,checked:0,unchecked:0,total:0};n.on("init",function(){}),n.on("render",function(e){$.assign(r,e),r.unchecked=r.total-r.checked,n.fill(r)})}),f("/Game/Table/Collection",function(e,t,n){function r(e){var t=e.table,n=e.index,r=e.row.index;return[t[r-1][n-1],t[r-1][n+0],t[r-1][n+1],t[r+0][n-1],t[r+0][n+1],t[r+1][n-1],t[r+1][n+0],t[r+1][n+1]]}function i(e,t){var n=t.table,i=t.index,a=t.row.index;if(!(0==i||i==t.row.length-1||0==a||a==n.length-1)){var l=0;r(t).forEach(function(e){e.data.checked&&l++}),3!=l?2!=l&&(l<2?t.data.checked&&e.push(t):l>3&&t.data.checked&&e.push(t)):t.data.checked||e.push(t)}}e("KISP");return{get:function(e){var t=[];return e.each(function(e){i(t,e)}),t}}}),d.panel("/Game/Sidebar",function(e,t,n){e("KISP");var r=t.require("Operator"),i=t.require("Config"),a=t.require("Stat"),l={frames:0,interval:0,total:0};return n.on("init",function(){function e(){t=u(function(){l.frames++,n.fire("frame"),t&&e()},l.interval)}var t=null;r.on({start:function(){t||(e(),i.enable(!1))},stop:function(){clearTimeout(t),t=null,i.enable(!0)},clear:function(){l.frames=0,a.render({frame:0,checked:0}),n.fire("clear")}}),i.on({change:function(e){l.interval=1e3/e.frequency,l.total=e.total,n.fire("apply",[e])}})}),n.on("render",function(e){r.render(),i.render(),a.render({frame:0,checked:0,total:l.total})}),{update:function(e){a.render({checked:e.checked,frame:l.frames,total:l.total})}}}),d.panel("/Game/Table",function(e,t,n){e("KISP");var r=e("Table"),i=t.require("Collection"),a=null;return n.on("init",function(){}),n.on("render",function(e){a&&a.destroy(),(a=new r({container:n.container,x:e.column,y:e.row,class:`size-${e.size}`})).on("click",{cell:function(e,t){var r=0,i=e.data,l=i.checked=!i.checked;e.$.toggleClass("on",l);r=a.stat(function(e){return!!e.data.checked});n.fire("check",[r])}}),a.render()}),{clear:function(){a&&a.each(function(e){e.data.checked=!1,e.$.removeClass("on")})},update:function(){return i.get(a).forEach(function(e){var t=e.data,n=t.checked=!t.checked;e.$.toggleClass("on",n)}),{checked:a.stat(function(e){return!!e.data.checked})}}}}),d.view("/Game",function(e,t,n){e("KISP");var r=t.require("Sidebar"),i=t.require("Table");n.on("init",function(){r.on({apply:function(e){i.render(e)},frame:function(){var e=i.update();r.update(e)},clear:function(){i.clear()}}),i.on({check:function(e){r.update({checked:e})}})}),n.on("render",function(){r.render()})}),d.launch(function(e,t,n){t.require("Game").render()})}(top,parent,window,document,location,localStorage,sessionStorage,window.console||{log:function(){},dir:function(){},clear:function(){},error:function(){},info:function(){},debug:function(){},warn:function(){}},history,setTimeout,setInterval,KISP,define,Array,Boolean,Date,Error,Function,JSON,Math,Number,Object,RegExp,String);